<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <meta charset="UTF-8">
    <title>Z3D</title>
    <link rel="stylesheet" type="text/css" href="../fonts/HelpMe.ttf">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

</head>
<body>

<style>
    .map-id {
        font-size: 12px;
    }
</style>

<div class="container-fluid">
    <div class="container">
        <h1>Admin Maps</h1>

        <div class="col">
            <h2>Maps</h2>

            <table class="table">
                <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Filename</th>
                    <th scope="col">Upload filename</th>
                    <th scope="col">Preview</th>
                    <th scope="col">Preview filename</th>
                    <th scope="col">Playable</th>
                    <th scope="col">Handle</th>
                </tr>
                </thead>
                <tbody>
                    <% if (maps.length > 0) {
                            for (const map of maps) { %>
                        <tr>
                            <td><p class="map-id"><%= map._id %></p></td>
                            <td><%= map.name %></td>
                            <td><%= map.filename %></td>
                            <td><%= map.uploadFilename %></td>
                            <td><%= map.preview %></td>
                            <td><%= map.previewFilename %></td>
                            <td><%= map.playable %></td>
                            <td>
                                <button data-id="<%= map._id %>" class="btn btn-danger delete-btn">Delete</button>
                                <% if (!map.playable) { %>
                                    <button data-id="<%= map._id %>" class="btn btn-success accept-btn">Accept</button>
                                <% } else { %>
                                    <button data-id="<%= map._id %>" class="btn btn-success unaccept-btn">Unaccept</button>
                                <% } %>
                            </td>
                        </tr>

                    <% }} else { %>
                        <tr><td>No maps</td></tr>
                    <% } %>
                </tbody>
            </table>



        </div>

        <div class="col">
            <h2>Register a map</h2>

            <div id="map-form-error" class="invalid-feedback">
                <% if (error !== undefined) error %>
            </div>

            <form id="map-form">
                <div class="mb-3">
                    <label for="map-name" class="form-label">Map name</label>
                    <input type="text" class="form-control" id="map-name" name="map-name">
                </div>
                <div class="mb-3">

                    <label for="map-file" class="form-label">Map file (model/glb)</label>
                    <input id="map-file"
                           name="map-file"
                           class="form-control"
                           type="file"
                           accept=".glb,.gltf,gltf/model+json,gltf/model-binary"
                    >

                </div>
                <div class="mb-3">

                    <label for="map-preview" class="form-label">Map preview</label>
                    <input id="map-preview"
                           name="map-preview"
                           class="form-control"
                           type="file"
                           accept="image/*"
                    >

                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>

        </div>

    </div>


</div>


<script src="https://code.jquery.com/jquery-3.7.0.min.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

<script>


    const $errorDiv = $('#map-form-error')

    $('#map-form').on('submit', async (e) => {
        e.preventDefault()

        const $name = $('#map-name')[0]
        const $file = $('#map-file')[0]
        const $preview = $('#map-preview')[0]

        $errorDiv.innerText = '' // empty last errors
        $name.classList.remove('is-invalid')
        $file.classList.remove('is-invalid')
        $preview.classList.remove('is-invalid')

        let errors = ''

        // name validation
        if ($name.value.length <= 0) {
            errors += ' Missing name '
            $name.classList.add('is-invalid')
        }

        // file validation
        if ($file.files.length <= 0 || $preview.files.length <= 0) {
            errors += ' Missing files '
            $file.classList.add('is-invalid')
            $preview.classList.add('is-invalid')
        } else {
            const formData  = new FormData();
            formData.append('mapName', $name.value)
            formData.append('map-file', $file.files[0])
            formData.append('map-preview', $preview.files[0])

            const response = await fetch('/admin/maps/register', {
                method: 'POST',
                body: formData
            })
        }

        $errorDiv.text(errors)
    })

    $('.delete-btn').on('click', async function (e) {
        e.preventDefault()

        let id = this.dataset['id']
        const response = await fetch('/admin/maps/delete', {
            method: 'post',
            body: JSON.stringify({_id: id}),
            headers: {
                "Content-Type": "application/json"
            },
        })
        location.reload();
    })

    $('.accept-btn').on('click', async function (e) {
        e.preventDefault()

        let id = this.dataset['id']
        const response = await fetch('/admin/maps/accept', {
            method: 'post',
            body: JSON.stringify({_id: id}),
            headers: {
                "Content-Type": "application/json"
            },
        })
        location.reload();
    })

    $('.unaccept-btn').on('click', async function (e) {
        e.preventDefault()

        let id = this.dataset['id']
        const response = await fetch('/admin/maps/unaccept', {
            method: 'post',
            body: JSON.stringify({_id: id}),
            headers: {
                "Content-Type": "application/json"
            },
        })
        location.reload();
    })

</script>


</body>
</html>