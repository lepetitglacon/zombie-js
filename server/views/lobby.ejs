<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <meta charset="UTF-8">
    <title>Z3D - Game Lobby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

</head>
<body>

<style>
    body {
        max-width: 100vw;
        max-height: 100vh;

        background: #333333;
    }
    .carousel-img {
        width: 500px;
        aspect-ratio: 16/9;
        margin: auto;
    }
    .carousel-main-img {
        width: 500px;
    }

    .btn {
        background: #880000;
        color: white;
        padding: 20px;
        border-radius: 5px;
    }

    .isReady {
        background: #C20707;
    }
    .isReadyCheckmark:before {
        content: 'READY';
        position: relative;
        right: 0;
    }
</style>

<h1>LOBBY</h1>

<div id="lobby" class="fluid-container">

    <div class="row d-flex">

        <div id="lobby-left" class="col">

            <div class="row">
                <div id="lobby-room-name-div" class="row">
                    <h2 id="lobby-room-name" class="red"><%= game.name %></h2>
                </div>
                <div id="lobby-room-id-div" class="row">
                    <h3 id="lobby-room-id" class="dark-red"><%= game._id %></h3>
                </div>
            </div>

            <div class="row">

                <div id="lobby-form" class="container">
                    <div class="col">

                        <form>
                            <!-- map slider -->
                            <div id="lobby-map-carousel" class="carousel slide">
                                <div class="carousel-inner">

                                    <%if (maps.length > 0) {
                                            for (const map of maps) {
                                    if (map.playable) {%>
                                        <div class="carousel-item <%= 'active' %>" data-map-name="<%= map.name %>" data-map-id="<%= map.id %>">
                                            <img src="<%= assetsPath %>/img/map-preview/<%= map.preview %>" class="d-block carousel-img" alt="...">
                                        </div>
                                    <% }
                                    }
                                    } else { %>
                                        <p>No map found</p>
                                    <%}%>

                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#lobby-map-carousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#lobby-map-carousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>

                            <!-- modifier -->

                        </form>
                    </div>
                </div>

                <div class="row">
                    <div class="d-flex justify-content-around mb-5">

                        <a id="lobby-btn-leave" href="/game/lobby/leave/<%= game._id %>" class="btn btn-red">Leave</a>
                        <button id="lobby-btn-ready" type="submit" class="btn btn-red">Ready</button>

                    </div>
                </div>


            </div>
        </div>

        <div id="lobby-right" class="col">
            
            <div id="lobby-right-header-parent">
                <h1 id="lobby-z3d" class="red">Z3D</h1>
                <div id="lobby-map-name" class="dark-red">Flora Square</div>
            </div>
            
            <div id="lobby-players">
                <ul id="lobby-players-list">
                    <li class="color-white">Esteban</li>
                    <li class="color-blue">OIM</li>
                    <li class="color-red">Swag</li>
                    <li class="color-green">Oui</li>
                </ul>
            </div>
            
            <div id="lobby-main-map-img-div">


                <!-- map slider -->
                <div id="lobby-main-map-carousel" class="carousel slide">
                    <div class="carousel-inner">

                        <%
                        if (maps.length > 0) {
                                for (const map of maps) {
                                    if (map.playable) {
                        %>

                            <div class="carousel-item active">
                                <img src="<%= assetsPath %>/img/map-preview/<%= map.preview %>" class="d-block carousel-main-img" alt="...">
                            </div>

                        <% }}} %>

                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
    
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

<script defer="defer">

    socket = io({
        query: {
            gameId: '<%= game._id %>',
            userId: '<%= user._id %>',
        },
    });

    const playerUl = document.getElementById('lobby-players-list')
    playerUl.innerHTML = ''

    function createPlayerLi(player, playerUl) {
        const li = document.createElement('li')
        li.innerText = player.gamename ?? player.username
        li.id = 'lobby-player-' + player._id
        li.classList.add('lobby-player')

        console.log(player.color)

        let hexa = player.color;
        li.style.color = '#' + hexa

        playerUl.append(li)
    }



    socket.on('connect', () => {
        console.log('connected')
    })

    const $carousel = $('#lobby-map-carousel')
    $carousel.on('slide.bs.carousel', (e) => {
        let active

        console.log(e)

        if (e.direction === 'left') {
            $('#lobby-main-map-carousel').carousel('next')
            if ($('#lobby-map-carousel .active').next().length === 0) {
                active = $('#lobby-map-carousel .active').parent().children().first()
            } else {
                active = $('#lobby-map-carousel .active').next()
            }
        } else {
            $('#lobby-main-map-carousel').carousel('prev')
            if ($('#lobby-map-carousel .active').prev().length === 0) {
                active = $('#lobby-map-carousel .active').parent().children().last()
            } else {
                active = $('#lobby-map-carousel .active').prev()
            }
        }

        console.log(active.data('mapName'))
        $('#lobby-map-name').text(active.data('mapName'))

        socket.emit('lobby-map-change', {
            direction: e.direction,
            mapName: active.data('mapName')
        })
    })

    socket.on('lobby-map-change', (e) => {
        $('#lobby-map-name').text(e.mapName)
        if (e.direction === 'left') {
            $('#lobby-main-map-carousel').carousel('next')
        } else {
            $('#lobby-main-map-carousel').carousel('prev')
        }
    })

    socket.on('get_players', (players) => {
        console.log('received players : ', players)
        playerUl.innerHTML = ''
        for (const playersKey in players) {
            createPlayerLi(players[playersKey], playerUl)
        }
        // for (const [playerId, player] of players.entries()) {
        //     createPlayerLi(player, playerUl)
        // }
    })

    socket.on('player_connect', (player) => {
        console.log('[LOBBY] player connected : ' + player.socketId)
        createPlayerLi(player, playerUl)
    })

    socket.on('player_disconnect', (socketId) => {
        console.log('player disconnected')
        const li = document.getElementById('lobby-player-' + socketId)
        if (li !== null) {
            li.remove()
        }
    })

    socket.on('player-ready', (playerReady) => {
        const el = document.getElementById('lobby-player-' + playerReady.userId)

        if (playerReady.isReady) {
            el.classList.add('isReadyCheckmark')
        } else {
            el.classList.remove('isReadyCheckmark')
        }

    })

    const btnReady = document.getElementById('lobby-btn-ready')
    btnReady.addEventListener('click', e => {
        e.preventDefault()

        let isReady = btnReady.classList.contains('isReady')

        btnReady.classList.toggle('isReady')

        socket.emit('ready', !isReady)
    })



</script>

</body>
</html>